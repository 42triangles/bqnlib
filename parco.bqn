âŸ¨TestâŸ© â† â€¢Import "testing.bqn" â‹„ Apâ€¿_f â† â€¢Import "misc.bqn"

Ex â† âŠ¢ â‹„ TestEx â† {ğ•¨Test Ex ğ•©}

Const â‡ {ğ•©Ë™âŠ¸â‹ˆ}
epsilon â‡ ConstâŸ¨âŸ©
Fail â‡ {(â‹ˆğ•©)Ë™}
42â€¿"foo" Test "foo" ApËœ Const 42 â‹„ âŸ¨"bar"âŸ© Test "foo" ApËœ Fail "bar"

_bindPlus â‡ {nâ€¿p _ğ•£ f: {(2=â‰ )â—¶âŸ¨(ğ•©Ë™ApËœÂ·NâŠ‘),{(Pğ•¨){ğ”½}ğ•©}Â´âŸ©Fğ•©}}
_bind â‡ {Failâ€¿ğ”½_bindPlus ğ•©}

Tag â‡ {ğ•©âŠ¸(â‰¤â—‹â‰ â—¶0â€¿(âŠ£â‰¡â‰ âŠ¸â†‘))â—¶âŸ¨â‹ˆ"expected {âŠ¢}"_fğ•©,ğ•©â‹ˆ (â‰ ğ•©)â†“âŠ¢âŸ©}
ex â†© Tag "foo" â‹„ "foo"â€¿"" TestEx "foo" â‹„ "foo"â€¿"bar" TestEx "foobar"
                 âŸ¨"expected foo"âŸ© TestEx "fo"

_map â‡ {Constâˆ˜ğ”½_bind ğ•©}
ex â†© âŠ‘_map Tag "foo" â‹„ 'f'â€¿"bar" TestEx "foobar"
                       âŸ¨"expected foo"âŸ© TestEx "bar"

_maperr â‡ {(Failâˆ˜ğ”½)â€¿Const _bindPlus ğ•©}
ex â†© 5âŠ¸â†‘_maperr Tag "foo" â‹„ "foo"â€¿"bar" TestEx "foobar"
                            âŸ¨"expec"âŸ© TestEx "bar"

Or â‡ {ağ•Šb: {â‹ˆâˆ˜ğ•©âŠ¸("{âŠ‘âŠ£} / {âŠ¢}"_f) _maperr b}â€¿Const _bindPlus a}
ex â†© "foo" Orâ—‹Tag "bar" â‹„ "foo"â€¿"bar" TestEx "foobar" â‹„ "bar"â€¿"" TestEx "bar"
                          âŸ¨"expected foo / expected bar"âŸ© TestEx "baz"
                          "foobar"â€¿"" Test "foobar" ApËœ "foobar" Orâ—‹Tag "foo"
                          "foo"â€¿"bar" Test "foobar" ApËœ "foo" Orâ—‹Tag "foobar"

_validtoerr â‡ {(â‰ âˆ˜âŠ‘â—¶âŸ¨Const 1âŠ‘âŠ¢,âŠ‘âŸ© ğ”½â‹ˆâŠ¢)_bind ğ•©}
ex â†© (3=â‰ )â—¶âŸ¨"expected three chars"âŸ©â€¿âŸ¨âŸ©_validtoerr "foobar" Orâ—‹Tag "foo"
  "foo"â€¿"baz" TestEx "foobaz"
  âŸ¨"expected three chars"âŸ© TestEx "foobar"
  âŸ¨"expected foobar / expected foo"âŸ© TestEx "baz"

_validerr_ â‡ {ğ”½â—¶âŸ¨ğ”¾âŸ©â€¿âŸ¨âŸ©_validtoerrğ•©}
ex â†© (3=â‰ )_validerr_"expected three chars" "foobar" Orâ—‹Tag "foo"
  "foo"â€¿"baz" TestEx "foobaz" â‹„ âŸ¨"expected three chars"âŸ© TestEx "foobar"

_valid â‡ {ğ”½_validerr_"validation failed" ğ•©}

Maybe â‡ â‹ˆ_map Or (Const âŸ¨âŸ©)Ë™
ex â†© Maybe Tag "foo" â‹„ âŸ¨"foo"âŸ©â€¿"bar" TestEx "foobar"
                       âŸ¨âŸ©â€¿"bar" TestEx "bar"

End â‡ (0=â‰ )â—¶âŸ¨â‹ˆ"expected end of input",â‹ˆËœâŸ¨âŸ©âŸ©
ex â†© end â‹„ âŸ¨âŸ©â€¿"" TestEx ""
           âŸ¨"expected end of input"âŸ© TestEx "foo"

Repeat0 â‡ {âŸ¨(Const ğ•©)Ë™,ğ•¨Ë™ğ•Šğ•©âˆ¾â‹ˆâŸ©_bindPlus ğ•¨}âŸœâŸ¨âŸ©
ex â†© Repeat0 Tag "foo" â‹„ âŸ¨"foo","foo","foo"âŸ©â€¿"bar" TestEx "foofoofoobar"
                         âŸ¨âŸ©â€¿"bar" TestEx "bar"

any â‡ {(0â‰ â‰ )â—¶âŸ¨â‹ˆ"unexpected end of input", âŠ‘â‹ˆ1âŠ¸â†“âŸ©}
ex â†© any â‹„ 'f'â€¿"oo" TestEx "foo"
           âŸ¨"unexpected end of input"âŸ© TestEx ""

Anyof â‡ {âŠ‘âˆ˜âˆŠâŸœğ•©_validerr_("expected any of '{âŠ¢}'"_fğ•©) any}
âŸ¨"acba", "dba"âŸ© Test "acbadba" ApËœ Repeat0 Anyof "abc"
âŸ¨"expected any of 'abc'"âŸ© Test "d" ApËœ Anyof "abc"

Pair â‡ {ğ•©Ë™âŠ¸{ğ•©âŠ¸â‹ˆ_mapğ•¨}_bindğ•¨}
ex â†© "foo" Pairâ—‹Tag "bar"
  âŸ¨"foo","bar"âŸ©â€¿"baz" TestEx "foobarbaz"
  âŸ¨"expected foo"âŸ© TestEx "barbaz" â‹„ âŸ¨"expected bar"âŸ© TestEx "foobaz"

_mappair â‡ {ğ•—Â´_mapğ•¨Pairğ•©}
Left â‡ âŠ£_mappair
Right â‡ âŠ¢_mappair
Repeat1 â‡ âŠ¢ â‹ˆâŠ¸âˆ¾_mappair Repeat0
Manyof0 â‡ Repeat0âˆ˜Anyof
Manyof1 â‡ Repeat1âˆ˜Anyof
ThenEnd â‡ LeftâŸœ(endË™)
